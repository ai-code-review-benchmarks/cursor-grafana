/*! For license information please see module.js.LICENSE.txt */
define(["@grafana/data","react","@emotion/css","@grafana/runtime","@grafana/ui","lodash","rxjs"],((e,t,r,n,a,o,i)=>(()=>{"use strict";var s={44:(e,t,r)=>{var n=r(959),a=Symbol.for("react.element"),o=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,s=n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,l={key:!0,ref:!0,__self:!0,__source:!0};function c(e,t,r){var n,o={},c=null,u=null;for(n in void 0!==r&&(c=""+r),void 0!==t.key&&(c=""+t.key),void 0!==t.ref&&(u=t.ref),t)i.call(t,n)&&!l.hasOwnProperty(n)&&(o[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps)void 0===o[n]&&(o[n]=t[n]);return{$$typeof:a,type:e,key:c,ref:u,props:o,_owner:s.current}}t.Fragment=o,t.jsx=c,t.jsxs=c},728:(e,t,r)=>{e.exports=r(44)},89:e=>{e.exports=r},781:t=>{t.exports=e},531:e=>{e.exports=n},7:e=>{e.exports=a},241:e=>{e.exports=o},959:e=>{e.exports=t},269:e=>{e.exports=i}},l={};function c(e){var t=l[e];if(void 0!==t)return t.exports;var r=l[e]={exports:{}};return s[e](r,r.exports,c),r.exports}c.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return c.d(t,{a:t}),t},c.d=(e,t)=>{for(var r in t)c.o(t,r)&&!c.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},c.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),c.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var u={};return(()=>{c.r(u),c.d(u,{plugin:()=>Dn});var e=c(781),t=c(728),r=c(89),n=c(959),a=c.n(n),o=c(7),i=Object.defineProperty,s=Object.defineProperties,l=Object.getOwnPropertyDescriptors,d=Object.getOwnPropertySymbols,p=Object.prototype.hasOwnProperty,h=Object.prototype.propertyIsEnumerable,f=(e,t,r)=>t in e?i(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,m=(e,t)=>{for(var r in t||(t={}))p.call(t,r)&&f(e,r,t[r]);if(d)for(var r of d(t))h.call(t,r)&&f(e,r,t[r]);return e};const y=({dataSourceName:e,docsLink:t,hasRequiredFields:n=!0,className:i})=>{const c=(0,o.useTheme2)(),u={container:(0,r.css)({p:{margin:0},"p + p":{marginTop:c.spacing(2)}}),text:(0,r.css)((d=m({},c.typography.body),p={color:c.colors.text.secondary,a:(0,r.css)({color:c.colors.text.link,textDecoration:"underline","&:hover":{textDecoration:"none"}})},s(d,l(p))))};var d,p;return a().createElement("div",{className:(0,r.cx)(u.container,i)},a().createElement("p",{className:u.text},"Before you can use the ",e," data source, you must configure it below or in the config file. For detailed instructions,"," ",a().createElement("a",{href:t,target:"_blank",rel:"noreferrer"},"view the documentation"),"."),n&&a().createElement("p",{className:u.text},a().createElement("i",null,"Fields marked with * are required")))};var b=Object.defineProperty,g=Object.defineProperties,v=Object.getOwnPropertyDescriptors,O=Object.getOwnPropertySymbols,j=Object.prototype.hasOwnProperty,w=Object.prototype.propertyIsEnumerable,T=(e,t,r)=>t in e?b(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,x=(e,t)=>{for(var r in t||(t={}))j.call(t,r)&&T(e,r,t[r]);if(O)for(var r of O(t))w.call(t,r)&&T(e,r,t[r]);return e};const C=({children:e,title:t,description:i,isCollapsible:s=!1,isInitiallyOpen:l=!0,kind:c="section",className:u})=>{const{colors:d,typography:p,spacing:h}=(0,o.useTheme2)(),[f,m]=(0,n.useState)(!s||l),y=f?"angle-up":"angle-down",b="sub-section"===c,O=`${f?"Collapse":"Expand"} section ${t}`,j={header:(0,r.css)({display:"flex",justifyContent:"space-between",alignItems:"center"}),title:(0,r.css)({margin:0}),subtitle:(0,r.css)({margin:0,fontWeight:p.fontWeightRegular}),descriptionText:(0,r.css)((w=x({marginTop:h(b?.25:.5),marginBottom:0},p.bodySmall),T={color:d.text.secondary},g(w,v(T)))),content:(0,r.css)({marginTop:h(2)})};var w,T;return a().createElement("div",{className:u},a().createElement("div",{className:j.header},"section"===c?a().createElement("h3",{className:j.title},t):a().createElement("h6",{className:j.subtitle},t),s&&a().createElement(o.IconButton,{name:y,onClick:()=>m(!f),type:"button",size:"xl","aria-label":O})),i&&a().createElement("p",{className:j.descriptionText},i),f&&a().createElement("div",{className:j.content},e))};var D=Object.defineProperty,P=Object.defineProperties,S=Object.getOwnPropertyDescriptors,F=Object.getOwnPropertySymbols,E=Object.prototype.hasOwnProperty,I=Object.prototype.propertyIsEnumerable,N=(e,t,r)=>t in e?D(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;const k=e=>{var t,r=e,{children:n}=r,o=((e,t)=>{var r={};for(var n in e)E.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&F)for(var n of F(e))t.indexOf(n)<0&&I.call(e,n)&&(r[n]=e[n]);return r})(r,["children"]);return a().createElement(C,(t=((e,t)=>{for(var r in t||(t={}))E.call(t,r)&&N(e,r,t[r]);if(F)for(var r of F(t))I.call(t,r)&&N(e,r,t[r]);return e})({},o),P(t,S({kind:"section"}))),n)};var A=Object.defineProperty,R=Object.defineProperties,q=Object.getOwnPropertyDescriptors,M=Object.getOwnPropertySymbols,_=Object.prototype.hasOwnProperty,B=Object.prototype.propertyIsEnumerable,J=(e,t,r)=>t in e?A(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;const L=({config:e,onChange:t,description:n,urlPlaceholder:i,urlTooltip:s,urlLabel:l,className:c})=>{const u=/^(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?$/.test(e.url),d={container:(0,r.css)({maxWidth:578})};return a().createElement(a().Fragment,null,a().createElement(k,{title:"Connection",description:n,className:(0,r.cx)(d.container,c)},a().createElement(o.InlineField,{htmlFor:"connection-url",label:l||"URL",labelWidth:24,tooltip:s||a().createElement(a().Fragment,null,"Specify a complete HTTP URL",a().createElement("br",null),"(for example https://example.com:8080)"),grow:!0,disabled:e.readOnly,required:!0,invalid:!u&&!e.readOnly,error:u?"":"Please enter a valid URL",interactive:!0},a().createElement(o.Input,{id:"connection-url","aria-label":"Data source connection URL",onChange:r=>{return t((n=((e,t)=>{for(var r in t||(t={}))_.call(t,r)&&J(e,r,t[r]);if(M)for(var r of M(t))B.call(t,r)&&J(e,r,t[r]);return e})({},e),a={url:r.currentTarget.value},R(n,q(a))));var n,a},value:e.url||"",placeholder:i||"URL"}))))},$=()=>({inlineFieldNoMarginRight:(0,r.css)({marginRight:0}),inlineFieldWithSecret:(0,r.css)({'[class$="layoutChildrenWrapper"]:first-child':{flexGrow:1}})}),W=({user:e,passwordConfigured:t,userLabel:n="User",userTooltip:i="The username of the data source account",userPlaceholder:s="User",passwordLabel:l="Password",passwordTooltip:c="The password of the data source account",passwordPlaceholder:u="Password",onUserChange:d,onPasswordChange:p,onPasswordReset:h,readOnly:f})=>{const m=$(),y={lastInlineField:(0,r.css)({marginBottom:0})};return a().createElement(a().Fragment,null,a().createElement(o.InlineField,{className:m.inlineFieldNoMarginRight,label:n,labelWidth:24,tooltip:i,required:!0,htmlFor:"basic-auth-user-input",interactive:!0,grow:!0,disabled:f},a().createElement(o.Input,{id:"basic-auth-user-input",placeholder:s,value:e,onChange:e=>d(e.currentTarget.value),required:!0})),a().createElement(o.InlineField,{className:(0,r.cx)(m.inlineFieldNoMarginRight,m.inlineFieldWithSecret,y.lastInlineField),label:l,labelWidth:24,tooltip:c,required:!0,htmlFor:"basic-auth-password-input",interactive:!0,grow:!0,disabled:f},a().createElement(o.SecretInput,{id:"basic-auth-password-input",isConfigured:t,onReset:f?()=>{}:h,placeholder:u,onChange:e=>p(e.currentTarget.value),required:!0})))};var G=Object.defineProperty,U=Object.defineProperties,z=Object.getOwnPropertyDescriptors,V=Object.getOwnPropertySymbols,H=Object.prototype.hasOwnProperty,Q=Object.prototype.propertyIsEnumerable,K=(e,t,r)=>t in e?G(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;const Y=e=>{var t,r=e,{children:n}=r,o=((e,t)=>{var r={};for(var n in e)H.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&V)for(var n of V(e))t.indexOf(n)<0&&Q.call(e,n)&&(r[n]=e[n]);return r})(r,["children"]);return a().createElement(C,(t=((e,t)=>{for(var r in t||(t={}))H.call(t,r)&&K(e,r,t[r]);if(V)for(var r of V(t))Q.call(t,r)&&K(e,r,t[r]);return e})({},o),U(t,z({kind:"sub-section"}))),n)};var Z=(e=>(e.NoAuth="NoAuth",e.BasicAuth="BasicAuth",e.OAuthForward="OAuthForward",e.CrossSiteCredentials="CrossSiteCredentials",e))(Z||{}),X=Object.defineProperty,ee=Object.defineProperties,te=Object.getOwnPropertyDescriptors,re=Object.getOwnPropertySymbols,ne=Object.prototype.hasOwnProperty,ae=Object.prototype.propertyIsEnumerable,oe=(e,t,r)=>t in e?X(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,ie=(e,t)=>{for(var r in t||(t={}))ne.call(t,r)&&oe(e,r,t[r]);if(re)for(var r of re(t))ae.call(t,r)&&oe(e,r,t[r]);return e},se=(e,t)=>ee(e,te(t));const le={[Z.BasicAuth]:{label:"Basic authentication",value:Z.BasicAuth,description:"Authenticate with your data source username and password"},[Z.CrossSiteCredentials]:{label:"Enable cross-site access control requests",value:Z.CrossSiteCredentials,description:"Allow cross-site Access-Control requests with your existing credentials and cookies. This enables the server to authenticate the user and perform authorized requests on their behalf on other domains."},[Z.OAuthForward]:{label:"Forward OAuth Identity",value:Z.OAuthForward,description:"Forward the OAuth access token (and if available: the OIDC ID token) of the user querying to the data source"},[Z.NoAuth]:{label:"No Authentication",value:Z.NoAuth,description:"Data source is available without authentication"}},ce=({selectedMethod:e,mostCommonMethod:t,visibleMethods:i,extendedDefaultOptions:s,customMethods:l,onAuthMethodSelect:c,basicAuth:u,readOnly:d})=>{var p,h,f,m;const[y,b]=(0,n.useState)(!1),{colors:g,spacing:v}=(0,o.useTheme2)(),O=(0,n.useMemo)((()=>{var e;return null!=i?i:[Z.BasicAuth,Z.OAuthForward,Z.NoAuth,...null!=(e=null==l?void 0:l.map((e=>e.id)))?e:[]]}),[l,i]),j=O.length>1,w=(0,n.useMemo)((()=>{var e;const r=null!=(e=null==l?void 0:l.reduce(((e,t)=>(e[t.id]={label:t.label,value:t.id,description:t.description},e)),{}))?e:{},n={};let a;for(a in le)s&&s[a]?n[a]=ie(ie({},le[a]),s[a]):n[a]=le[a];const o=ie(ie({},r),n);return O.filter((e=>Boolean(o[e]))).map((e=>{const r=o[e];return e===t&&j?se(ie({},r),{label:`${r.label} (most common)`}):r}))}),[O,l,s,t,j]);let T=e;j?e===Z.NoAuth&&t&&!y&&(T=t):T=O[0];let x=null;T===Z.BasicAuth&&u?x=a().createElement(W,se(ie({},u),{readOnly:d})):T.startsWith("custom-")&&(x=null!=(h=null==(p=null==l?void 0:l.find((e=>e.id===T)))?void 0:p.component)?h:null);const C=j?"Authentication methods":null!=(f=w[0].label)?f:"",D=j?"Choose an authentication method to access the data source":null!=(m=w[0].description)?m:"",P={authMethods:(0,r.css)(ie({marginTop:v(2.5)},j&&{padding:v(2),border:`1px solid ${g.border.weak}`})),selectedMethodFields:(0,r.css)({marginTop:v(1.5)})};return a().createElement(Y,{title:C,description:D},a().createElement("div",{className:P.authMethods},j&&a().createElement(o.Select,{options:w,value:T,onChange:e=>{b(!0),c(e.value)},disabled:d}),x&&a().createElement("div",{className:P.selectedMethodFields},x)))},ue=({children:e,enabled:t,label:n,tooltipText:i,onToggle:s,readOnly:l})=>{const{colors:c,spacing:u}=(0,o.useTheme2)(),d={container:(0,r.css)({marginTop:3}),checkboxContainer:(0,r.css)({display:"flex",alignItems:"center"}),infoIcon:(0,r.css)({marginTop:-2,marginLeft:5,color:c.text.secondary}),content:(0,r.css)({margin:u(1,0,2,3)})};return a().createElement("div",{className:d.container},a().createElement("div",{className:d.checkboxContainer},a().createElement(o.Checkbox,{value:t,label:n,onChange:()=>s(!t),disabled:l}),a().createElement(o.Tooltip,{placement:"top",content:i,interactive:!0},a().createElement(o.Icon,{name:"info-circle",className:d.infoIcon,size:"sm"}))),t&&e&&a().createElement("div",{className:d.content},e))},de=({enabled:e,certificateConfigured:t,onToggle:n,onCertificateChange:i,onCertificateReset:s,tooltips:l,readOnly:c})=>{var u;const d=$();return a().createElement(ue,{enabled:e,label:"Add self-signed certificate",tooltipText:"Add your own Certificate Authority (CA) certificate on top of one generated by the certificate authorities for additional security measures",onToggle:e=>n(e),readOnly:c},a().createElement(o.InlineField,{label:"CA Certificate",labelWidth:24,tooltip:null!=(u=null==l?void 0:l.certificateLabel)?u:"Your self-signed certificate",required:!0,htmlFor:"self-signed-certificate-input",interactive:!0,grow:!0,className:(0,r.cx)(d.inlineFieldNoMarginRight,d.inlineFieldWithSecret),disabled:c},a().createElement(o.SecretTextArea,{id:"self-signed-certificate-input",isConfigured:t,onChange:e=>i(e.currentTarget.value),onReset:c?()=>{}:s,placeholder:"Begins with --- BEGIN CERTIFICATE ---",rows:6,required:!0})))},pe=({enabled:e,serverName:t,clientCertificateConfigured:n,clientKeyConfigured:i,onToggle:s,onServerNameChange:l,onClientCertificateChange:c,onClientKeyChange:u,onClientCertificateReset:d,onClientKeyReset:p,tooltips:h,readOnly:f})=>{var m,y,b;const g=$();return a().createElement(ue,{enabled:e,label:"TLS Client Authentication",tooltipText:"Validate using TLS client authentication, in which the server authenticates the client",onToggle:e=>s(e),readOnly:f},a().createElement(o.InlineField,{label:"ServerName",labelWidth:24,tooltip:null!=(m=null==h?void 0:h.serverNameLabel)?m:"A Servername is used to verify the hostname on the returned certificate",required:!0,htmlFor:"client-auth-servername-input",interactive:!0,grow:!0,className:g.inlineFieldNoMarginRight,disabled:f},a().createElement(o.Input,{id:"client-auth-servername-input",placeholder:"domain.example.com",value:t,onChange:e=>l(e.currentTarget.value),required:!0})),a().createElement(o.InlineField,{label:"Client Certificate",labelWidth:24,tooltip:null!=(y=null==h?void 0:h.certificateLabel)?y:"The client certificate can be generated from a Certificate Authority or be self-signed",required:!0,htmlFor:"client-auth-client-certificate-input",interactive:!0,grow:!0,className:(0,r.cx)(g.inlineFieldNoMarginRight,g.inlineFieldWithSecret),disabled:f},a().createElement(o.SecretTextArea,{id:"client-auth-client-certificate-input",isConfigured:n,onChange:e=>c(e.currentTarget.value),onReset:f?()=>{}:d,placeholder:"Begins with --- BEGIN CERTIFICATE ---",rows:6,required:!0})),a().createElement(o.InlineField,{label:"Client Key",labelWidth:24,tooltip:null!=(b=null==h?void 0:h.keyLabel)?b:"The client key can be generated from a Certificate Authority or be self-signed",required:!0,htmlFor:"client-auth-client-key-input",interactive:!0,grow:!0,className:(0,r.cx)(g.inlineFieldNoMarginRight,g.inlineFieldWithSecret),disabled:f},a().createElement(o.SecretTextArea,{id:"client-auth-client-key-input",isConfigured:i,onChange:e=>u(e.currentTarget.value),onReset:f?()=>{}:p,placeholder:"Begins with --- RSA PRIVATE KEY CERTIFICATE ---",rows:6,required:!0})))},he=({enabled:e,onToggle:t,readOnly:r})=>a().createElement(ue,{enabled:e,label:"Skip TLS certificate validation",tooltipText:"Skipping TLS certificate validation is not recommended unless absolutely necessary or for testing",onToggle:e=>t(e),readOnly:r});var fe=Object.defineProperty,me=Object.defineProperties,ye=Object.getOwnPropertyDescriptors,be=Object.getOwnPropertySymbols,ge=Object.prototype.hasOwnProperty,ve=Object.prototype.propertyIsEnumerable,Oe=(e,t,r)=>t in e?fe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,je=(e,t)=>{for(var r in t||(t={}))ge.call(t,r)&&Oe(e,r,t[r]);if(be)for(var r of be(t))ve.call(t,r)&&Oe(e,r,t[r]);return e},we=(e,t)=>me(e,ye(t));const Te=({selfSignedCertificate:e,TLSClientAuth:t,skipTLSVerification:n,readOnly:i})=>{const{spacing:s}=(0,o.useTheme2)(),l={container:(0,r.css)({marginTop:s(3)})};return a().createElement(Y,{className:l.container,title:"TLS settings",description:"Additional security measures that can be applied on top of authentication"},a().createElement(de,we(je({},e),{readOnly:i})),a().createElement(pe,we(je({},t),{readOnly:i})),a().createElement(he,we(je({},n),{readOnly:i})))};var xe=Object.defineProperty,Ce=Object.defineProperties,De=Object.getOwnPropertyDescriptors,Pe=Object.getOwnPropertySymbols,Se=Object.prototype.hasOwnProperty,Fe=Object.prototype.propertyIsEnumerable,Ee=(e,t,r)=>t in e?xe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Ie=(e,t)=>{for(var r in t||(t={}))Se.call(t,r)&&Ee(e,r,t[r]);if(Pe)for(var r of Pe(t))Fe.call(t,r)&&Ee(e,r,t[r]);return e},Ne=(e,t)=>Ce(e,De(t));const ke=({header:e,onChange:t,onBlur:n,onDelete:i,readOnly:s})=>{const{spacing:l}=(0,o.useTheme2)(),c=$(),u={container:(0,r.css)({alignItems:"center"}),input:(0,r.css)({minWidth:"100%"}),headerNameField:(0,r.css)({width:"40%",marginRight:0,paddingRight:l(1)}),headerValueField:(0,r.css)({width:"45%",marginRight:0}),removeHeaderBtn:(0,r.css)({margin:"0 0 3px 10px"})};return a().createElement(a().Fragment,null,a().createElement(o.InlineFieldRow,{className:u.container},a().createElement(o.InlineField,{label:"Header",labelWidth:9,grow:!0,className:u.headerNameField,htmlFor:`custom-header-${e.id}-name-input`,disabled:s},a().createElement(o.Input,{id:`custom-header-${e.id}-name-input`,placeholder:"X-Custom-Header",value:e.name,width:12,onChange:r=>t(Ne(Ie({},e),{name:r.currentTarget.value})),onBlur:n,className:u.input})),a().createElement(o.InlineField,{label:"Value",labelWidth:9,grow:!0,className:(0,r.cx)(c.inlineFieldWithSecret,u.headerValueField),htmlFor:`custom-header-${e.id}-value-input`,disabled:s},a().createElement(o.SecretInput,{id:`custom-header-${e.id}-value-input`,isConfigured:e.configured,placeholder:"Header value",value:e.value,width:12,onChange:r=>t(Ne(Ie({},e),{value:r.currentTarget.value})),onReset:s?()=>{}:()=>t(Ne(Ie({},e),{configured:!1,value:""})),onBlur:n,className:u.input})),a().createElement(o.IconButton,{name:"trash-alt",tooltip:"Remove header",tooltipPlacement:"top",className:u.removeHeaderBtn,onClick:i,type:"button",disabled:s})))};var Ae=Object.defineProperty,Re=Object.defineProperties,qe=Object.getOwnPropertyDescriptors,Me=Object.getOwnPropertySymbols,_e=Object.prototype.hasOwnProperty,Be=Object.prototype.propertyIsEnumerable,Je=(e,t,r)=>t in e?Ae(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Le=(e,t)=>{for(var r in t||(t={}))_e.call(t,r)&&Je(e,r,t[r]);if(Me)for(var r of Me(t))Be.call(t,r)&&Je(e,r,t[r]);return e},$e=(e,t)=>Re(e,qe(t));const We=({headers:e,onChange:t,readOnly:i})=>{const{spacing:s}=(0,o.useTheme2)(),[l,c]=(0,n.useState)(e.map((e=>$e(Le({},e),{id:Ge(),value:""}))));(0,n.useEffect)((()=>{c((t=>{let r=!1;const n=t.map((t=>{var n;const a=null==(n=e.find((e=>e.name===t.name)))?void 0:n.configured;return void 0!==a&&t.configured!==a?(r=!0,$e(Le({},t),{configured:a})):t}));return r?n:t}))}),[e]);const u=()=>{t(l.map((({name:e,value:t,configured:r})=>({name:e,value:t,configured:r}))))},d={container:(0,r.css)({marginTop:s(3)}),addHeaderButton:(0,r.css)({marginTop:s(1.5)})};return a().createElement("div",{className:d.container},a().createElement(Y,{title:"HTTP headers",description:"Pass along additional context and metadata about the request/response",isCollapsible:!0,isInitiallyOpen:l.length>0},a().createElement("div",null,l.map((e=>a().createElement(ke,{key:e.id,header:e,onChange:e=>((e,t)=>{c(l.map((r=>r.id===e?Le({},t):r)))})(e.id,e),onDelete:()=>(e=>{const r=l.findIndex((t=>t.id===e));if(-1===r)return;const n=[...l];n.splice(r,1),c(n),t(n.map((({name:e,value:t,configured:r})=>({name:e,value:t,configured:r}))))})(e.id),onBlur:u,readOnly:i})))),a().createElement("div",{className:d.addHeaderButton},a().createElement(o.Button,{icon:"plus",variant:"secondary",fill:"outline",onClick:()=>{c([...l,{id:Ge(),name:"",value:"",configured:!1}])},disabled:i},0===l.length?"Add header":"Add another header"))))};function Ge(){return Math.random().toString(16).slice(2)}var Ue=Object.defineProperty,ze=Object.defineProperties,Ve=Object.getOwnPropertyDescriptors,He=Object.getOwnPropertySymbols,Qe=Object.prototype.hasOwnProperty,Ke=Object.prototype.propertyIsEnumerable,Ye=(e,t,r)=>t in e?Ue(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Ze=(e,t)=>{for(var r in t||(t={}))Qe.call(t,r)&&Ye(e,r,t[r]);if(He)for(var r of He(t))Ke.call(t,r)&&Ye(e,r,t[r]);return e},Xe=(e,t)=>ze(e,Ve(t));const et=({selectedMethod:e,mostCommonMethod:t,visibleMethods:n,extendedDefaultOptions:o,customMethods:i,onAuthMethodSelect:s,basicAuth:l,TLS:c,customHeaders:u,readOnly:d=!1})=>{const p={container:(0,r.css)({maxWidth:578})};return a().createElement("div",{className:p.container},a().createElement(k,{title:"Authentication"},a().createElement(ce,{selectedMethod:e,mostCommonMethod:t,customMethods:i,visibleMethods:n,extendedDefaultOptions:o,onAuthMethodSelect:s,basicAuth:l,readOnly:d}),c&&a().createElement(Te,Xe(Ze({},c),{readOnly:d})),u&&a().createElement(We,Xe(Ze({},u),{readOnly:d}))))};var tt=Object.defineProperty,rt=Object.defineProperties,nt=Object.getOwnPropertyDescriptors,at=Object.getOwnPropertySymbols,ot=Object.prototype.hasOwnProperty,it=Object.prototype.propertyIsEnumerable,st=(e,t,r)=>t in e?tt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,lt=(e,t)=>{for(var r in t||(t={}))ot.call(t,r)&&st(e,r,t[r]);if(at)for(var r of at(t))it.call(t,r)&&st(e,r,t[r]);return e},ct=(e,t)=>rt(e,nt(t));const ut="httpHeaderName",dt="httpHeaderValue";function pt({config:e,onChange:t}){return{selectedMethod:ht(e),onAuthMethodSelect:ft(e,t),basicAuth:mt(e,t),TLS:yt(e,t),customHeaders:bt(e,t),readOnly:e.readOnly}}function ht(e){return e.basicAuth?Z.BasicAuth:e.withCredentials?Z.CrossSiteCredentials:e.jsonData.oauthPassThru?Z.OAuthForward:Z.NoAuth}function ft(e,t){return r=>{t(ct(lt({},e),{basicAuth:r===Z.BasicAuth,withCredentials:r===Z.CrossSiteCredentials,jsonData:ct(lt({},e.jsonData),{oauthPassThru:r===Z.OAuthForward})}))}}function mt(e,t){return{user:e.basicAuthUser,passwordConfigured:e.secureJsonFields.basicAuthPassword,onUserChange:r=>t(ct(lt({},e),{basicAuthUser:r})),onPasswordChange:r=>t(ct(lt({},e),{secureJsonData:ct(lt({},e.secureJsonData),{basicAuthPassword:r})})),onPasswordReset:()=>t(ct(lt({},e),{secureJsonData:ct(lt({},e.secureJsonData),{basicAuthPassword:""}),secureJsonFields:ct(lt({},e.secureJsonFields),{basicAuthPassword:!1})}))}}function yt(e,t){return{selfSignedCertificate:{enabled:Boolean(e.jsonData.tlsAuthWithCACert),certificateConfigured:e.secureJsonFields.tlsCACert,onToggle:r=>t(ct(lt({},e),r?{jsonData:ct(lt({},e.jsonData),{tlsAuthWithCACert:r})}:{jsonData:ct(lt({},e.jsonData),{tlsAuthWithCACert:r}),secureJsonData:ct(lt({},e.secureJsonData),{tlsCACert:""}),secureJsonFields:ct(lt({},e.secureJsonFields),{tlsCACert:!1})})),onCertificateChange:r=>t(ct(lt({},e),{secureJsonData:ct(lt({},e.secureJsonData),{tlsCACert:r})})),onCertificateReset:()=>t(ct(lt({},e),{secureJsonData:ct(lt({},e.secureJsonData),{tlsCACert:""}),secureJsonFields:ct(lt({},e.secureJsonFields),{tlsCACert:!1})}))},TLSClientAuth:{enabled:e.jsonData.tlsAuth,serverName:e.jsonData.serverName,clientCertificateConfigured:e.secureJsonFields.tlsClientCert,clientKeyConfigured:e.secureJsonFields.tlsClientKey,onToggle:r=>t(ct(lt({},e),r?{jsonData:ct(lt({},e.jsonData),{tlsAuth:r})}:{jsonData:ct(lt({},e.jsonData),{tlsAuth:r,serverName:""}),secureJsonData:ct(lt({},e.secureJsonData),{tlsClientCert:"",tlsClientKey:""}),secureJsonFields:ct(lt({},e.secureJsonFields),{tlsClientCert:!1,tlsClientKey:!1})})),onServerNameChange:r=>t(ct(lt({},e),{jsonData:ct(lt({},e.jsonData),{serverName:r})})),onClientCertificateChange:r=>t(ct(lt({},e),{secureJsonData:ct(lt({},e.secureJsonData),{tlsClientCert:r})})),onClientCertificateReset:()=>t(ct(lt({},e),{secureJsonData:ct(lt({},e.secureJsonData),{tlsClientCert:""}),secureJsonFields:ct(lt({},e.secureJsonFields),{tlsClientCert:!1})})),onClientKeyChange:r=>t(ct(lt({},e),{secureJsonData:ct(lt({},e.secureJsonData),{tlsClientKey:r})})),onClientKeyReset:()=>t(ct(lt({},e),{secureJsonData:ct(lt({},e.secureJsonData),{tlsClientKey:""}),secureJsonFields:ct(lt({},e.secureJsonFields),{tlsClientKey:!1})}))},skipTLSVerification:{enabled:e.jsonData.tlsSkipVerify,onToggle:r=>t(ct(lt({},e),{jsonData:ct(lt({},e.jsonData),{tlsSkipVerify:r})}))}}}function bt(e,t){return{headers:Object.keys(e.jsonData).filter((e=>e.startsWith(ut))).sort().map((t=>{var r;const n=t.slice(ut.length);return{name:e.jsonData[t],configured:null!=(r=e.secureJsonFields[`${dt}${n}`])&&r}})),onChange:r=>{const n=Object.fromEntries(Object.entries(e.jsonData).filter((([e])=>!e.startsWith(ut)))),a=Object.fromEntries(Object.entries(e.secureJsonData||{}).filter((([e])=>!e.startsWith(dt)))),o=Object.fromEntries(Object.entries(e.secureJsonFields).filter((([e])=>!e.startsWith(dt))));r.forEach(((e,t)=>{n[`${ut}${t+1}`]=e.name,e.configured?o[`${dt}${t+1}`]=!0:a[`${dt}${t+1}`]=e.value})),t(ct(lt({},e),{jsonData:n,secureJsonData:a,secureJsonFields:o}))}}}var gt=Object.defineProperty,vt=Object.defineProperties,Ot=Object.getOwnPropertyDescriptors,jt=Object.getOwnPropertySymbols,wt=Object.prototype.hasOwnProperty,Tt=Object.prototype.propertyIsEnumerable,xt=(e,t,r)=>t in e?gt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Ct=(e,t)=>{for(var r in t||(t={}))wt.call(t,r)&&xt(e,r,t[r]);if(jt)for(var r of jt(t))Tt.call(t,r)&&xt(e,r,t[r]);return e},Dt=(e,t)=>vt(e,Ot(t));const Pt=({config:e,onChange:t,className:n})=>{const i={container:(0,r.css)({maxWidth:578})};return a().createElement(Y,{title:"Advanced HTTP settings",className:(0,r.cx)(i.container,n)},a().createElement(o.InlineField,{htmlFor:"advanced-http-cookies",label:"Allowed cookies",labelWidth:24,tooltip:"Grafana proxy deletes forwarded cookies by default. Specify cookies by name that should be forwarded to the data source.",disabled:e.readOnly,grow:!0},a().createElement(o.TagsInput,{id:"advanced-http-cookies",placeholder:"New cookie (hit enter to add)",tags:e.jsonData.keepCookies,onChange:r=>{t(Dt(Ct({},e),{jsonData:Dt(Ct({},e.jsonData),{keepCookies:r})}))}})),a().createElement(o.InlineField,{htmlFor:"advanced-http-timeout",label:"Timeout",labelWidth:24,tooltip:"HTTP request timeout in seconds",disabled:e.readOnly,grow:!0},a().createElement(o.Input,{id:"advanced-http-timeout",type:"number",min:0,placeholder:"Timeout in seconds","aria-label":"Timeout in seconds",value:e.jsonData.timeout,onChange:r=>{t(Dt(Ct({},e),{jsonData:Dt(Ct({},e.jsonData),{timeout:parseInt(r.currentTarget.value,10)})}))}})))};function St(e){const{description:t,suffix:r,feature:n}=e,i=`Learn more about ${n}`,s=(0,o.useStyles2)(Ft);return a().createElement("span",{className:s.container},t,a().createElement("a",{"aria-label":i,href:`https://grafana.com/docs/grafana/next/datasources/${r}`,rel:"noreferrer",target:"_blank"},i))}const Ft=e=>({container:(0,r.css)({color:e.colors.text.secondary,a:(0,r.css)({color:e.colors.text.link,textDecoration:"underline",marginLeft:"5px","&:hover":{textDecoration:"none"}})})});var Et=c(531);const It=/^(-?\d+(?:\.\d+)?)(ms|[Mwdhmsy])$/,Nt=(e,t)=>!(e.match(t)||!e);function kt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const At=e=>{const r=e.validationRegex||It,[a,i]=(0,n.useState)((()=>!!e.value&&Nt(e.value,r)));var s;!function(e,t,r){void 0===t&&(t=0),void 0===r&&(r=[]);var a=function(e,t){void 0===t&&(t=0);var r=(0,n.useRef)(!1),a=(0,n.useRef)(),o=(0,n.useRef)(e),i=(0,n.useCallback)((function(){return r.current}),[]),s=(0,n.useCallback)((function(){r.current=!1,a.current&&clearTimeout(a.current),a.current=setTimeout((function(){r.current=!0,o.current()}),t)}),[t]),l=(0,n.useCallback)((function(){r.current=null,a.current&&clearTimeout(a.current)}),[]);return(0,n.useEffect)((function(){o.current=e}),[e]),(0,n.useEffect)((function(){return s(),l}),[t]),[i,l,s]}(e,t),o=a[0],i=a[1],s=a[2];(0,n.useEffect)(s,r)}((()=>{i(Nt(e.value,r))}),500,[e.value]);const l={labelWidth:26,disabled:null!==(s=e.disabled)&&void 0!==s&&s,invalid:a,error:e.isInvalidError};return e.label&&(l.label=e.label,l.tooltip=e.tooltip||""),(0,t.jsx)(o.InlineField,(c=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){kt(e,t,r[t])}))}return e}({},l),u=null!=(u={children:(0,t.jsx)(o.Input,{type:"text",placeholder:e.placeholder||"0",width:e.width||40,onChange:t=>{e.onChange(t.currentTarget.value)},value:e.value,"aria-label":e.ariaLabel||"interval input"})})?u:{},Object.getOwnPropertyDescriptors?Object.defineProperties(c,Object.getOwnPropertyDescriptors(u)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(u)).forEach((function(e){Object.defineProperty(c,e,Object.getOwnPropertyDescriptor(u,e))})),c));var c,u};function Rt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function qt(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Rt(e,t,r[t])}))}return e}function Mt(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const _t=({values:e,onChange:n,id:a})=>{const i=(0,o.useStyles2)(Bt);return(0,t.jsx)("div",{className:i.wrapper,children:e.length?e.map(((s,l)=>(0,t.jsxs)("div",{className:i.pair,children:[(0,t.jsx)(o.SegmentInput,{id:`${a}-key-${l}`,placeholder:"Tag name",value:s.key,onChange:t=>{n(e.map(((e,r)=>r===l?Mt(qt({},e),{key:String(t)}):e)))}}),(0,t.jsx)(o.InlineLabel,{"aria-label":"equals",className:i.operator,children:"as"}),(0,t.jsx)(o.SegmentInput,{id:`${a}-value-${l}`,placeholder:"New name (optional)",value:s.value||"",onChange:t=>{n(e.map(((e,r)=>r===l?Mt(qt({},e),{value:String(t)}):e)))}}),(0,t.jsx)(o.ToolbarButton,{onClick:()=>n([...e.slice(0,l),...e.slice(l+1)]),className:(0,r.cx)(i.removeTag,"query-part"),"aria-label":"Remove tag",type:"button",icon:"times"}),l===e.length-1?(0,t.jsx)(o.ToolbarButton,{onClick:()=>n([...e,{key:"",value:""}]),className:"query-part","aria-label":"Add tag",type:"button",icon:"plus"}):null]},l))):(0,t.jsx)(o.ToolbarButton,{icon:"plus",onClick:()=>n([...e,{key:"",value:""}]),className:"query-part","aria-label":"Add tag",type:"button"})})},Bt=e=>({wrapper:(0,r.css)({display:"flex",flexDirection:"column",gap:`${e.spacing(.5)} 0`}),pair:(0,r.css)({display:"flex",justifyContent:"start",alignItems:"center"}),operator:(0,r.css)({color:e.v1.palette.orange,width:"auto"}),removeTag:(0,r.css)({marginRight:e.spacing(.5)})});function Jt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Lt(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Jt(e,t,r[t])}))}return e}function $t(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function Wt({options:e,onOptionsChange:a}){const i=["loki","elasticsearch","grafana-splunk-datasource","grafana-opensearch-datasource","grafana-falconlogscale-datasource","googlecloud-logging-datasource"],s=(0,n.useMemo)((()=>function(e){var t;if(null==e?void 0:e.tracesToLogsV2)return e.tracesToLogsV2;if(!(null==e?void 0:e.tracesToLogs))return;const r={customQuery:!1};return r.datasourceUid=e.tracesToLogs.datasourceUid,r.tags=e.tracesToLogs.mapTagNamesEnabled?e.tracesToLogs.mappedTags:null===(t=e.tracesToLogs.tags)||void 0===t?void 0:t.map((e=>({key:e}))),r.filterByTraceID=e.tracesToLogs.filterByTraceID,r.filterBySpanID=e.tracesToLogs.filterBySpanID,r.spanStartTimeShift=e.tracesToLogs.spanStartTimeShift,r.spanEndTimeShift=e.tracesToLogs.spanEndTimeShift,r}(e.jsonData)||{customQuery:!1}),[e.jsonData]),{query:l="",tags:c,customQuery:u}=s,d=(0,n.useCallback)((t=>{a($t(Lt({},e),{jsonData:$t(Lt({},e.jsonData),{tracesToLogsV2:Lt({},s,t),tracesToLogs:void 0})}))}),[a,e,s]);return(0,t.jsxs)("div",{className:(0,r.css)({width:"100%"}),children:[(0,t.jsx)(o.InlineFieldRow,{children:(0,t.jsx)(o.InlineField,{tooltip:"The logs data source the trace is going to navigate to",label:"Data source",labelWidth:26,children:(0,t.jsx)(Et.DataSourcePicker,{inputId:"trace-to-logs-data-source-picker",filter:e=>i.includes(e.type),current:s.datasourceUid,noDefault:!0,width:40,onChange:e=>d({datasourceUid:e.uid})})})}),(0,t.jsx)(o.InlineFieldRow,{children:(0,t.jsx)(At,{label:Ut("start"),tooltip:zt("start","0"),value:s.spanStartTimeShift||"",onChange:e=>{d({spanStartTimeShift:e})},isInvalidError:Vt})}),(0,t.jsx)(o.InlineFieldRow,{children:(0,t.jsx)(At,{label:Ut("end"),tooltip:zt("end","0"),value:s.spanEndTimeShift||"",onChange:e=>{d({spanEndTimeShift:e})},isInvalidError:Vt})}),(0,t.jsx)(o.InlineFieldRow,{children:(0,t.jsx)(o.InlineField,{tooltip:"Tags that will be used in the query. Default tags: 'cluster', 'hostname', 'namespace', 'pod', 'service.name', 'service.namespace'",label:"Tags",labelWidth:26,children:(0,t.jsx)(_t,{values:null!=c?c:[],onChange:e=>d({tags:e})})})}),(0,t.jsx)(Gt,{disabled:u,type:"trace",id:"filterByTraceID",value:Boolean(s.filterByTraceID),onChange:e=>d({filterByTraceID:e})}),(0,t.jsx)(Gt,{disabled:u,type:"span",id:"filterBySpanID",value:Boolean(s.filterBySpanID),onChange:e=>d({filterBySpanID:e})}),(0,t.jsx)(o.InlineFieldRow,{children:(0,t.jsx)(o.InlineField,{tooltip:"Use a custom query with the possibility to interpolate variables from the trace or span",label:"Use custom query",labelWidth:26,children:(0,t.jsx)(o.InlineSwitch,{id:"customQuerySwitch",value:u,onChange:e=>d({customQuery:e.currentTarget.checked})})})}),u&&(0,t.jsx)(o.InlineField,{label:"Query",labelWidth:26,tooltip:"The query that will run when navigating from a trace to logs data source. Interpolate tags using the `$__tags` keyword",grow:!0,children:(0,t.jsx)(o.Input,{label:"Query",type:"text",allowFullScreen:!0,value:l,onChange:e=>d({query:e.currentTarget.value})})})]})}function Gt(e){return(0,t.jsx)(o.InlineFieldRow,{children:(0,t.jsx)(o.InlineField,{disabled:e.disabled,label:`Filter by ${e.type} ID`,labelWidth:26,grow:!0,tooltip:`Filters logs by ${e.type} ID, where the ${e.type} ID should be part of the log line`,children:(0,t.jsx)(o.InlineSwitch,{id:e.id,value:e.value,onChange:t=>e.onChange(t.currentTarget.checked)})})})}const Ut=e=>`Span ${e} time shift`,zt=(e,t)=>`Shifts the ${e} time of the span. Default: ${t} (Time units can be used here, for example: 5s, -1m, 3h)`,Vt="Invalid time shift. See tooltip for examples.",Ht=({options:e,onOptionsChange:r})=>{let n=e.type;return n+="tempo"===e.type?"/configure-tempo-data-source/#trace-to-logs":"/#trace-to-logs",(0,t.jsx)(k,{title:"Trace to logs",description:(0,t.jsx)(St,{description:"Navigate from a trace span to the selected data source's logs.",suffix:n,feature:"trace to logs"}),isCollapsible:!0,isInitiallyOpen:!0,children:(0,t.jsx)(Wt,{options:e,onOptionsChange:r})})};function Qt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Kt(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Qt(e,t,r[t])}))}return e}function Yt(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function Zt({options:n,onOptionsChange:a}){var i,s,l,c,u,d,p;const h=(0,o.useStyles2)(er);var f;return(0,t.jsxs)("div",{className:(0,r.css)({width:"100%"}),children:[(0,t.jsxs)(o.InlineFieldRow,{className:h.row,children:[(0,t.jsx)(o.InlineField,{tooltip:"The Prometheus data source the trace is going to navigate to",label:"Data source",labelWidth:26,children:(0,t.jsx)(Et.DataSourcePicker,{inputId:"trace-to-metrics-data-source-picker",pluginId:"prometheus",current:null===(i=n.jsonData.tracesToMetrics)||void 0===i?void 0:i.datasourceUid,noDefault:!0,width:40,onChange:t=>(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:a,options:n},"tracesToMetrics",Yt(Kt({},n.jsonData.tracesToMetrics),{datasourceUid:t.uid}))})}),(null===(s=n.jsonData.tracesToMetrics)||void 0===s?void 0:s.datasourceUid)?(0,t.jsx)(o.Button,{type:"button",variant:"secondary",size:"sm",fill:"text",onClick:()=>{(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:a,options:n},"tracesToMetrics",Yt(Kt({},n.jsonData.tracesToMetrics),{datasourceUid:void 0}))},children:"Clear"}):null]}),(0,t.jsx)(o.InlineFieldRow,{children:(0,t.jsx)(At,{label:Ut("start"),tooltip:zt("start","-2m"),value:(null===(l=n.jsonData.tracesToMetrics)||void 0===l?void 0:l.spanStartTimeShift)||"",onChange:t=>{(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:a,options:n},"tracesToMetrics",Yt(Kt({},n.jsonData.tracesToMetrics),{spanStartTimeShift:t}))},placeholder:"-2m",isInvalidError:Vt})}),(0,t.jsx)(o.InlineFieldRow,{children:(0,t.jsx)(At,{label:Ut("end"),tooltip:zt("end","2m"),value:(null===(c=n.jsonData.tracesToMetrics)||void 0===c?void 0:c.spanEndTimeShift)||"",onChange:t=>{(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:a,options:n},"tracesToMetrics",Yt(Kt({},n.jsonData.tracesToMetrics),{spanEndTimeShift:t}))},placeholder:"2m",isInvalidError:Vt})}),(0,t.jsx)(o.InlineFieldRow,{children:(0,t.jsx)(o.InlineField,{tooltip:"Tags that will be used in the metrics query",label:"Tags",labelWidth:26,children:(0,t.jsx)(_t,{values:null!==(f=null===(u=n.jsonData.tracesToMetrics)||void 0===u?void 0:u.tags)&&void 0!==f?f:[],onChange:t=>(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:a,options:n},"tracesToMetrics",Yt(Kt({},n.jsonData.tracesToMetrics),{tags:t}))})})}),null===(p=n.jsonData.tracesToMetrics)||void 0===p||null===(d=p.queries)||void 0===d?void 0:d.map(((r,i)=>(0,t.jsxs)("div",{className:h.queryRow,children:[(0,t.jsx)(o.InlineField,{label:"Link Label",labelWidth:26,tooltip:"Descriptive label for the linked query",children:(0,t.jsx)(o.Input,{label:"Link Label",type:"text",allowFullScreen:!0,value:r.name,width:40,onChange:t=>{var r,o;const s=(null!==(o=null===(r=n.jsonData.tracesToMetrics)||void 0===r?void 0:r.queries)&&void 0!==o?o:[]).map(((e,r)=>r===i?Yt(Kt({},e),{name:t.currentTarget.value}):e));(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:a,options:n},"tracesToMetrics",Yt(Kt({},n.jsonData.tracesToMetrics),{queries:s}))}})}),(0,t.jsx)(o.InlineField,{label:"Query",labelWidth:10,tooltip:"The Prometheus query that will run when navigating from a trace to metrics. Interpolate tags using the `$__tags` keyword",grow:!0,children:(0,t.jsx)(o.Input,{label:"Query",type:"text",allowFullScreen:!0,value:r.query,onChange:t=>{var r,o;const s=(null!==(o=null===(r=n.jsonData.tracesToMetrics)||void 0===r?void 0:r.queries)&&void 0!==o?o:[]).map(((e,r)=>r===i?Yt(Kt({},e),{query:t.currentTarget.value}):e));(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:a,options:n},"tracesToMetrics",Yt(Kt({},n.jsonData.tracesToMetrics),{queries:s}))}})}),(0,t.jsx)(o.Button,{variant:"destructive",title:"Remove query",icon:"times",type:"button",onClick:()=>{var t;const r=null===(t=n.jsonData.tracesToMetrics)||void 0===t?void 0:t.queries.filter(((e,t)=>t!==i));(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:a,options:n},"tracesToMetrics",Yt(Kt({},n.jsonData.tracesToMetrics),{queries:r}))}})]},i))),(0,t.jsx)(o.Button,{variant:"secondary",title:"Add query",icon:"plus",type:"button",onClick:()=>{var t,r;(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:a,options:n},"tracesToMetrics",Yt(Kt({},n.jsonData.tracesToMetrics),{queries:[...null!==(r=null===(t=n.jsonData.tracesToMetrics)||void 0===t?void 0:t.queries)&&void 0!==r?r:[],{query:""}]}))},children:"Add query"})]})}const Xt=({options:e,onOptionsChange:r})=>{let n=e.type;return n+="tempo"===e.type?"/configure-tempo-data-source/#trace-to-metrics":"/#trace-to-metrics",(0,t.jsx)(k,{title:"Trace to metrics",description:(0,t.jsx)(St,{description:"Navigate from a trace span to the selected data source's metrics.",suffix:n,feature:"trace to metrics"}),isCollapsible:!0,isInitiallyOpen:!0,children:(0,t.jsx)(Zt,{options:e,onOptionsChange:r})})},er=e=>({infoText:{paddingBottom:e.spacing(2),color:e.colors.text.secondary},row:(0,r.css)({label:"row",alignItems:"baseline"}),queryRow:(0,r.css)({label:"queryRow",display:"flex",flexFlow:"wrap"})});function tr(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function rr({options:r,onOptionsChange:n}){var a;const i=(0,o.useStyles2)(ar);return(0,t.jsx)("div",{className:i.container,children:(0,t.jsx)(o.InlineFieldRow,{className:i.row,children:(0,t.jsx)(o.InlineField,{tooltip:"Displays the node graph above the trace view. Default: disabled",label:"Enable node graph",labelWidth:26,children:(0,t.jsx)(o.InlineSwitch,{id:"enableNodeGraph",value:null===(a=r.jsonData.nodeGraph)||void 0===a?void 0:a.enabled,onChange:t=>{return(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:n,options:r},"nodeGraph",(a=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){tr(e,t,r[t])}))}return e}({},r.jsonData.nodeGraph),o=null!=(o={enabled:t.currentTarget.checked})?o:{},Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(o)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(o)).forEach((function(e){Object.defineProperty(a,e,Object.getOwnPropertyDescriptor(o,e))})),a));var a,o}})})})})}const nr=({options:e,onOptionsChange:r})=>{let n=e.type;return n+="tempo"===e.type?"/configure-tempo-data-source/#node-graph":"/#node-graph",(0,t.jsx)(Y,{title:"Node graph",description:(0,t.jsx)(St,{description:"Show or hide the node graph visualization.",suffix:n,feature:"the node graph"}),children:(0,t.jsx)(rr,{options:e,onOptionsChange:r})})},ar=e=>({infoText:(0,r.css)({label:"infoText",paddingBottom:e.spacing(2),color:e.colors.text.secondary}),container:(0,r.css)({label:"container",width:"100%"}),row:(0,r.css)({label:"row",alignItems:"baseline"})});function or(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ir(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){or(e,t,r[t])}))}return e}function sr(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const lr="None",cr="Duration",ur="Tag";function dr({options:n,onOptionsChange:a}){var i,s,l;const c=(0,o.useStyles2)(hr),u=[lr,cr,ur].map(e.toOption);return(0,t.jsxs)("div",{className:(0,r.css)({width:"100%"}),children:[(0,t.jsx)(o.InlineFieldRow,{className:c.row,children:(0,t.jsx)(o.InlineField,{label:"Label",labelWidth:26,tooltip:"Default: duration",grow:!0,children:(0,t.jsx)(o.Select,{inputId:"label",options:u,value:(null===(i=n.jsonData.spanBar)||void 0===i?void 0:i.type)||"",onChange:t=>{var r;(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:a,options:n},"spanBar",sr(ir({},n.jsonData.spanBar),{type:null!==(r=null==t?void 0:t.value)&&void 0!==r?r:""}))},placeholder:"Duration",isClearable:!0,"aria-label":"select-label-name",width:40})})}),(null===(s=n.jsonData.spanBar)||void 0===s?void 0:s.type)===ur&&(0,t.jsx)(o.InlineFieldRow,{className:c.row,children:(0,t.jsx)(o.InlineField,{label:"Tag key",labelWidth:26,tooltip:"Tag key which will be used to get the tag value. A span's attributes and resources will be searched for the tag key",children:(0,t.jsx)(o.Input,{type:"text",placeholder:"Enter tag key",onChange:t=>(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:a,options:n},"spanBar",sr(ir({},n.jsonData.spanBar),{tag:t.currentTarget.value})),value:(null===(l=n.jsonData.spanBar)||void 0===l?void 0:l.tag)||"",width:40})})})]})}const pr=({options:e,onOptionsChange:r})=>{let n=e.type;return n+="tempo"===e.type?"/configure-tempo-data-source/#span-bar":"/#span-bar",(0,t.jsx)(Y,{title:"Span bar",description:(0,t.jsx)(St,{description:"Add additional info next to the service and operation on a span bar row in the trace view.",suffix:n,feature:"the span bar"}),children:(0,t.jsx)(dr,{options:e,onOptionsChange:r})})},hr=e=>({infoText:(0,r.css)({label:"infoText",paddingBottom:e.spacing(2),color:e.colors.text.secondary}),row:(0,r.css)({label:"row",alignItems:"baseline"})});function fr(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function mr(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){fr(e,t,r[t])}))}return e}const yr=e=>({container:(0,r.css)({marginBottom:e.spacing(2),maxWidth:"900px"})});var br=c(241),gr=function(e,t){return gr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},gr(e,t)};function vr(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}gr(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var Or=function(){return Or=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},Or.apply(this,arguments)};function jr(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function wr(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,a,o=r.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)i.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(a)throw a.error}}return i}function Tr(e,t,r){if(r||2===arguments.length)for(var n,a=0,o=t.length;a<o;a++)!n&&a in t||(n||(n=Array.prototype.slice.call(t,0,a)),n[a]=t[a]);return e.concat(n||Array.prototype.slice.call(t))}function xr(){var e=(0,n.useRef)(!1),t=(0,n.useCallback)((function(){return e.current}),[]);return(0,n.useEffect)((function(){return e.current=!0,function(){e.current=!1}}),[]),t}function Cr(e,t,r){void 0===t&&(t=[]),void 0===r&&(r={loading:!1});var a=(0,n.useRef)(0),o=xr(),i=(0,n.useState)(r),s=i[0],l=i[1],c=(0,n.useCallback)((function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var n=++a.current;return s.loading||l((function(e){return Or(Or({},e),{loading:!0})})),e.apply(void 0,t).then((function(e){return o()&&n===a.current&&l({value:e,loading:!1}),e}),(function(e){return o()&&n===a.current&&l({error:e,loading:!1}),e}))}),t);return[s,c]}Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;const Dr=function(e){var t;t=function(){e()},(0,n.useEffect)(t,[])};var Pr;!function(e){e[e.Error=7e3]="Error",e[e.Info=3e3]="Info",e[e.Success=3e3]="Success",e[e.Warning=5e3]="Warning"}(Pr||(Pr={}));const Sr={error:7e3,info:3e3,success:3e3,warning:5e3},Fr=e=>{const a=(i=(0,o.useTheme2)(),(0,r.css)({position:"absolute",zIndex:i.zIndex.portal,top:0,right:10}));var i;const[s,l]=(0,n.useState)(!1),[c,u]=(0,n.useState)();return(0,n.useEffect)((()=>()=>{c&&clearTimeout(c)}),[c]),(0,n.useEffect)((()=>{if(""!==e.text){l(!0);const t=setTimeout((()=>{l(!1)}),Sr[e.severity]);u(t)}}),[e.severity,e.text]),(0,t.jsx)(t.Fragment,{children:s&&(0,t.jsx)(o.Alert,{className:a,elevated:!0,onRemove:()=>l(!1),severity:e.severity,title:e.text})})},Er="/api/v2";function Ir(e,t,r,n,a,o,i){try{var s=e[o](i),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function Nr(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Ir(o,n,a,i,s,"next",e)}function s(e){Ir(o,n,a,i,s,"throw",e)}i(void 0)}))}}function kr(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Ar(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){kr(e,t,r[t])}))}return e}function Rr(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const qr=e=>({tracesCascader:(0,r.css)({label:"tracesCascader",marginRight:e.spacing(1)})}),Mr=[{label:"No traces found",value:"no_traces",isLeaf:!0}],_r={"[No traces in time range]":"__NO_TRACES__"};var Br=c(269);function Jr(e){return"function"==typeof e}var Lr,$r=((Lr=function(e){var t;t=this,Error.call(t),t.stack=(new Error).stack,this.message=e?e.length+" errors occurred during unsubscription:\n"+e.map((function(e,t){return t+1+") "+e.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=e}).prototype=Object.create(Error.prototype),Lr.prototype.constructor=Lr,Lr);function Wr(e,t){if(e){var r=e.indexOf(t);0<=r&&e.splice(r,1)}}var Gr=function(){function e(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}var t;return e.prototype.unsubscribe=function(){var e,t,r,n,a;if(!this.closed){this.closed=!0;var o=this._parentage;if(o)if(this._parentage=null,Array.isArray(o))try{for(var i=jr(o),s=i.next();!s.done;s=i.next())s.value.remove(this)}catch(t){e={error:t}}finally{try{s&&!s.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}else o.remove(this);var l=this.initialTeardown;if(Jr(l))try{l()}catch(e){a=e instanceof $r?e.errors:[e]}var c=this._finalizers;if(c){this._finalizers=null;try{for(var u=jr(c),d=u.next();!d.done;d=u.next()){var p=d.value;try{Ur(p)}catch(e){a=null!=a?a:[],e instanceof $r?a=Tr(Tr([],wr(a)),wr(e.errors)):a.push(e)}}}catch(e){r={error:e}}finally{try{d&&!d.done&&(n=u.return)&&n.call(u)}finally{if(r)throw r.error}}}if(a)throw new $r(a)}},e.prototype.add=function(t){var r;if(t&&t!==this)if(this.closed)Ur(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=null!==(r=this._finalizers)&&void 0!==r?r:[]).push(t)}},e.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},e.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},e.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&Wr(t,e)},e.prototype.remove=function(t){var r=this._finalizers;r&&Wr(r,t),t instanceof e&&t._removeParent(this)},e.EMPTY=((t=new e).closed=!0,t),e}();function Ur(e){Jr(e)?e():e.unsubscribe()}Gr.EMPTY;var zr=null,Vr=null,Hr=!1,Qr=!1,Kr={setTimeout:function(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];var a=Kr.delegate;return(null==a?void 0:a.setTimeout)?a.setTimeout.apply(a,Tr([e,t],wr(r))):setTimeout.apply(void 0,Tr([e,t],wr(r)))},clearTimeout:function(e){var t=Kr.delegate;return((null==t?void 0:t.clearTimeout)||clearTimeout)(e)},delegate:void 0};function Yr(){}var Zr=Xr("C",void 0,void 0);function Xr(e,t,r){return{kind:e,value:t,error:r}}var en=function(e){function t(t){var r,n=e.call(this)||this;return n.isStopped=!1,t?(n.destination=t,((r=t)instanceof Gr||r&&"closed"in r&&Jr(r.remove)&&Jr(r.add)&&Jr(r.unsubscribe))&&t.add(n)):n.destination=ln,n}return vr(t,e),t.create=function(e,t,r){return new an(e,t,r)},t.prototype.next=function(e){this.isStopped?sn(function(e){return Xr("N",e,void 0)}(e),this):this._next(e)},t.prototype.error=function(e){this.isStopped?sn(Xr("E",void 0,e),this):(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped?sn(Zr,this):(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(Gr),tn=Function.prototype.bind;function rn(e,t){return tn.call(e,t)}var nn=function(){function e(e){this.partialObserver=e}return e.prototype.next=function(e){var t=this.partialObserver;if(t.next)try{t.next(e)}catch(e){on(e)}},e.prototype.error=function(e){var t=this.partialObserver;if(t.error)try{t.error(e)}catch(e){on(e)}else on(e)},e.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(e){on(e)}},e}(),an=function(e){function t(t,r,n){var a,o,i=e.call(this)||this;return Jr(t)||!t?a={next:null!=t?t:void 0,error:null!=r?r:void 0,complete:null!=n?n:void 0}:i&&Qr?((o=Object.create(t)).unsubscribe=function(){return i.unsubscribe()},a={next:t.next&&rn(t.next,o),error:t.error&&rn(t.error,o),complete:t.complete&&rn(t.complete,o)}):a=t,i.destination=new nn(a),i}return vr(t,e),t}(en);function on(e){Hr||function(e){Kr.setTimeout((function(){if(!zr)throw e;zr(e)}))}(e)}function sn(e,t){var r=Vr;r&&Kr.setTimeout((function(){return r(e,t)}))}var ln={closed:!0,next:Yr,error:function(e){throw e},complete:Yr},cn=function(e){function t(t,r,n,a,o,i){var s=e.call(this,t)||this;return s.onFinalize=o,s.shouldUnsubscribe=i,s._next=r?function(e){try{r(e)}catch(e){t.error(e)}}:e.prototype._next,s._error=a?function(e){try{a(e)}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._error,s._complete=n?function(){try{n()}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._complete,s}return vr(t,e),t.prototype.unsubscribe=function(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var r=this.closed;e.prototype.unsubscribe.call(this),!r&&(null===(t=this.onFinalize)||void 0===t||t.call(this))}},t}(en);function un(e,t){return r=function(r,n){var a=0;r.subscribe(new cn(n,(function(r){n.next(e.call(t,r,a++))}),void 0,void 0,void 0))},function(e){if(function(e){return Jr(null==e?void 0:e.lift)}(e))return e.lift((function(e){try{return r(e,this)}catch(e){this.error(e)}}));throw new TypeError("Unable to lift unknown Observable type")};var r}function dn(e,t,r){return{main:`${pn(e)}ms (${pn(e/t*100)}%)`,secondary:`${pn(r)}ms (${pn(r/e*100)}%)`}}function pn(e){return parseFloat(e.toFixed(2))}function hn(t){const r=t.map(fn),n=new e.MutableDataFrame({fields:[{name:"traceID",type:e.FieldType.string,values:[]},{name:"spanID",type:e.FieldType.string,values:[]},{name:"parentSpanID",type:e.FieldType.string,values:[]},{name:"operationName",type:e.FieldType.string,values:[]},{name:"serviceName",type:e.FieldType.string,values:[]},{name:"serviceTags",type:e.FieldType.other,values:[]},{name:"startTime",type:e.FieldType.number,values:[]},{name:"duration",type:e.FieldType.number,values:[]},{name:"logs",type:e.FieldType.other,values:[]},{name:"tags",type:e.FieldType.other,values:[]}],meta:{preferredVisualisationType:"trace",custom:{traceFormat:"zipkin"}}});for(const e of r)n.add(e);return n}function fn(e){var t,r,n,a;const o={traceID:e.traceId,spanID:e.id,parentSpanID:e.parentId,operationName:e.name,serviceName:(null===(t=e.localEndpoint)||void 0===t?void 0:t.serviceName)||(null===(r=e.remoteEndpoint)||void 0===r?void 0:r.serviceName)||"unknown",serviceTags:yn(e),startTime:e.timestamp/1e3,duration:e.duration/1e3,logs:null!==(a=null===(n=e.annotations)||void 0===n?void 0:n.map(mn))&&void 0!==a?a:[],tags:Object.keys(e.tags||{}).reduce(((t,r)=>"error"===r?(t.push({key:"error",value:!0}),t.push({key:"errorValue",value:e.tags.error}),t):(t.push({key:r,value:e.tags[r]}),t)),[])};var i,s;return e.kind&&(o.tags=[{key:"kind",value:e.kind},...null!==(i=o.tags)&&void 0!==i?i:[]]),e.shared&&(o.tags=[{key:"shared",value:e.shared},...null!==(s=o.tags)&&void 0!==s?s:[]]),o}function mn(e){return{timestamp:e.timestamp,fields:[{key:"annotation",value:e.value}]}}function yn(e){const t=e.localEndpoint||e.remoteEndpoint;return t?[bn("ipv4",t.ipv4),bn("ipv6",t.ipv6),bn("port",t.port),bn("endpointType",e.localEndpoint?"local":"remote")].filter((e=>Boolean(e))):[]}function bn(e,t){if(t)return{key:e,value:t}}function gn(e,t,r,n,a,o,i){try{var s=e[o](i),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function vn(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){gn(o,n,a,i,s,"next",e)}function s(e){gn(o,n,a,i,s,"throw",e)}i(void 0)}))}}function On(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function jn(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){On(e,t,r[t])}))}return e}function wn(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}class Tn extends e.DataSourceApi{query(e){const t=e.targets[0];if("upload"===t.queryType){if(!this.uploadedJson)return(0,Br.of)({data:[]});try{var r;const e=JSON.parse(this.uploadedJson);return(0,Br.of)(xn({data:e},null===(r=this.nodeGraph)||void 0===r?void 0:r.enabled))}catch(e){return(0,Br.of)({error:{message:"JSON is not valid Zipkin format"},data:[]})}}if(t.query){const r=this.applyVariables(t,e.scopedVars);return this.request(`${Er}/trace/${encodeURIComponent(r.query)}`).pipe(un((e=>{var t;return xn(e,null===(t=this.nodeGraph)||void 0===t?void 0:t.enabled)})))}return(0,Br.of)(Cn)}metadataRequest(e,t){var r=this;return vn((function*(){return(yield(0,Br.lastValueFrom)(r.request(e,t,{hideFromInspector:!0}))).data}))()}testDatasource(){var e=this;return vn((function*(){return yield e.metadataRequest(`${Er}/services`),{status:"success",message:"Data source is working"}}))()}getQueryDisplayText(e){return e.query}interpolateVariablesInQueries(e,t){return e&&0!==e.length?e.map((e=>jn(wn(jn({},e),{datasource:this.getRef()}),this.applyVariables(e,t)))):[]}applyVariables(e,t){const r=jn({},e);var n;return wn(jn({},r),{query:this.templateSrv.replace(null!==(n=e.query)&&void 0!==n?n:"",t)})}request(t,r,n){const a=r?e.urlUtil.serializeParams(r):"",o=`${this.instanceSettings.url}${t}${a.length?`?${a}`:""}`,i=wn(jn({},n),{url:o});return(0,Et.getBackendSrv)().fetch(i)}constructor(e,t=(0,Et.getTemplateSrv)()){super(e),On(this,"instanceSettings",void 0),On(this,"templateSrv",void 0),On(this,"uploadedJson",void 0),On(this,"nodeGraph",void 0),On(this,"spanBar",void 0),this.instanceSettings=e,this.templateSrv=t,this.uploadedJson=null,this.nodeGraph=e.jsonData.nodeGraph}}function xn(t,r=!1){let n=(null==t?void 0:t.data)?[hn(null==t?void 0:t.data)]:[];return r&&n.push(...function(t){const{nodes:r,edges:n}=function(t){const r=[],n=[],a=function(e){let t=0,r=1/0;for(const n of e)n.timestamp<r&&(r=n.timestamp),n.timestamp+n.duration>t&&(t=n.timestamp+n.duration);return t-r}(t),o=function(e){const t={};let r;for(let n=0;r=e(n),r;n++){t[r.id]?t[r.id].span=r.span:t[r.id]={span:r.span,children:[]};for(const e of r.parentIds)e&&(t[e]?t[e].children.push(r.id):t[e]={span:void 0,children:[r.id]})}return t}((e=>{if(!(e>=t.length))return{span:t[e],id:t[e].id,parentIds:t[e].parentId?[t[e].parentId]:[]}}));for(const c of t){var i,s;const t=((l=o[c.id].children.map((e=>{const t=o[e].span;return[t.timestamp,t.timestamp+t.duration]}))).sort(((e,t)=>e[0]-t[0])),l.reduce(((e,t)=>{if(!e.length)return[t];const r=e.slice(-1)[0],[n,a]=r,[o,i]=t;return i<a?e:o>a?[...e,t]:[...e.slice(0,-1),[n,i]]}),[]).reduce(((e,t)=>e+(t[1]-t[0])),0)),u=c.duration-t,d=dn(c.duration/1e3,a/1e3,u/1e3);r.push({[e.NodeGraphDataFrameFieldNames.id]:c.id,[e.NodeGraphDataFrameFieldNames.title]:(null===(i=c.localEndpoint)||void 0===i?void 0:i.serviceName)||(null===(s=c.remoteEndpoint)||void 0===s?void 0:s.serviceName)||"unknown",[e.NodeGraphDataFrameFieldNames.subTitle]:c.name,[e.NodeGraphDataFrameFieldNames.mainStat]:d.main,[e.NodeGraphDataFrameFieldNames.secondaryStat]:d.secondary,[e.NodeGraphDataFrameFieldNames.color]:u/a}),c.parentId&&o[c.parentId].span&&n.push({[e.NodeGraphDataFrameFieldNames.id]:c.parentId+"--"+c.id,[e.NodeGraphDataFrameFieldNames.target]:c.id,[e.NodeGraphDataFrameFieldNames.source]:c.parentId})}var l;return{nodes:r,edges:n}}(t),[a,o]=[new e.MutableDataFrame({fields:[{name:e.NodeGraphDataFrameFieldNames.id,type:e.FieldType.string},{name:e.NodeGraphDataFrameFieldNames.title,type:e.FieldType.string},{name:e.NodeGraphDataFrameFieldNames.subTitle,type:e.FieldType.string},{name:e.NodeGraphDataFrameFieldNames.mainStat,type:e.FieldType.string,config:{displayName:"Total time (% of trace)"}},{name:e.NodeGraphDataFrameFieldNames.secondaryStat,type:e.FieldType.string,config:{displayName:"Self time (% of total)"}},{name:e.NodeGraphDataFrameFieldNames.color,type:e.FieldType.number,config:{color:{mode:"continuous-GrYlRd"},displayName:"Self time / Trace duration"}}],meta:{preferredVisualisationType:"nodeGraph"}}),new e.MutableDataFrame({fields:[{name:e.NodeGraphDataFrameFieldNames.id,type:e.FieldType.string},{name:e.NodeGraphDataFrameFieldNames.target,type:e.FieldType.string},{name:e.NodeGraphDataFrameFieldNames.source,type:e.FieldType.string}],meta:{preferredVisualisationType:"nodeGraph"}})];for(const e of r)a.add(e);for(const e of n)o.add(e);return[a,o]}(null==t?void 0:t.data)),{data:n}}const Cn={data:[(0,e.createDataFrame)({fields:[{name:"trace",type:e.FieldType.trace,values:[]}],meta:{preferredVisualisationType:"trace",custom:{traceFormat:"zipkin"}}})]},Dn=new e.DataSourcePlugin(Tn).setQueryEditor((({query:e,onChange:a,onRunQuery:i,datasource:s})=>{const[l,c]=(0,n.useState)(!1),[u,d]=(0,n.useState)(""),p=function(e,t){const r=`${Er}/services`,[n,a]=Cr(Nr((function*(){try{const t=yield e.metadataRequest(r);return t?t.sort().map((e=>({label:e,value:e,isLeaf:!1}))):[]}catch(e){const r=`Failed to load spans from Zipkin: ${(e instanceof Error?e:"An unknown error occurred").toString()}`;throw t(r),e}})),[e]);return Dr((()=>{a()})),n}(s,d),h=(0,o.useTheme2)(),f=(0,o.useStyles2)(qr),{onLoadOptions:m,allOptions:y}=function(e,t){const r=xr(),[a,o]=(0,n.useState)({}),[,i]=Cr((c=Nr((function*(n){const a=`${Er}/spans`;try{const t=yield e.metadataRequest(a,{serviceName:n});r()&&o((e=>{const r=(0,br.fromPairs)(t.map((e=>[e,void 0])));return Rr(Ar({},e),{[n]:r})}))}catch(e){const r=`Failed to load spans from Zipkin: ${(e instanceof Error?e:"An unknown error occurred").toString()}`;throw t(r),e}})),function(e){return c.apply(this,arguments)}),[e,a]),[,s]=Cr((l=Nr((function*(n,a){const i=`${Er}/traces`,s={serviceName:n,spanName:a};try{const t=yield e.metadataRequest(i,s);if(r()){const e=t.length?(0,br.fromPairs)(t.map((e=>{const t=e.find((e=>!e.parentId));return[`${t.name} [${Math.floor(t.duration/1e3)} ms]`,t.traceId]}))):_r;o((t=>{const r=t[n];return Rr(Ar({},t),{[n]:Rr(Ar({},r),{[a]:e})})}))}}catch(e){const r=`Failed to load spans from Zipkin: ${(e instanceof Error?e:"An unknown error occurred").toString()}`;throw t(r),e}})),function(e,t){return l.apply(this,arguments)}),[e]);var l,c;return{onLoadOptions:(0,n.useCallback)((e=>{const t=e[0].value;if(1===e.length)i(t);else if(2===e.length){const r=e[1].value;s(t,r)}}),[i,s]),allOptions:a}}(s,d),b=(0,n.useCallback)(((t,r)=>{if(3===r.length){const t=r[2].value;a(Rr(Ar({},e),{query:t})),i()}}),[a,i,e]);(0,n.useEffect)((()=>{e.queryType||a(Rr(Ar({},e),{queryType:"traceID"}))}),[e,a]);let g=function(e,t){return(0,n.useMemo)((()=>{let r=[];return e.value&&e.value.length?r=e.value.map((e=>Rr(Ar({},e),{children:t[e.value]&&Object.keys(t[e.value]).map((r=>({label:r,value:r,isLeaf:!1,children:t[e.value][r]&&Object.keys(t[e.value][r]).map((n=>({label:n,value:t[e.value][r][n]})))})))}))):e.value&&!e.value.length&&(r=Mr),r}),[e,t])}(p,y);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(o.Modal,{title:"Upload trace",isOpen:l,onDismiss:()=>c(!1),children:(0,t.jsx)("div",{className:(0,r.css)({padding:h.spacing(2)}),children:(0,t.jsx)(o.FileDropzone,{options:{multiple:!1},onLoad:t=>{s.uploadedJson=t,a(Rr(Ar({},e),{queryType:"upload"})),c(!1),i()}})})}),(0,t.jsx)(o.InlineFieldRow,{children:(0,t.jsx)(o.InlineField,{label:"Query type",grow:!0,children:(0,t.jsxs)(o.HorizontalGroup,{spacing:"sm",align:"center",justify:"space-between",children:[(0,t.jsx)(o.RadioButtonGroup,{options:[{value:"traceID",label:"TraceID"}],value:e.queryType||"traceID",onChange:t=>a(Rr(Ar({},e),{queryType:t})),size:"md"}),(0,t.jsx)(o.Button,{variant:"secondary",size:"sm",onClick:()=>{c(!0)},children:"Import trace"})]})})}),"traceID"===e.queryType&&(0,t.jsxs)(o.InlineFieldRow,{children:[(0,t.jsx)(o.ButtonCascader,{options:g,onChange:b,loadData:m,variant:"secondary",buttonProps:{className:f.tracesCascader},children:"Traces"}),(0,t.jsx)("div",{className:"gf-form gf-form--grow flex-shrink-1 min-width-15",children:(0,t.jsx)(o.QueryField,{query:e.query,onChange:t=>{const r=Rr(Ar({},e),{query:t});a(r)},onRunQuery:i,placeholder:"Insert Trace ID (run with Shift+Enter)",portalOrigin:"zipkin"})})]}),u&&(0,t.jsx)(Fr,{text:u,severity:"error"})]})})).setConfigEditor((({options:e,onOptionsChange:r})=>{const n=(0,o.useStyles2)(yr);return(0,t.jsxs)("div",{className:n.container,children:[(0,t.jsx)(y,{dataSourceName:"Zipkin",docsLink:"https://grafana.com/docs/grafana/latest/datasources/zipkin",hasRequiredFields:!1}),(0,t.jsx)(o.Divider,{spacing:4}),(0,t.jsx)(L,{config:e,onChange:r,urlPlaceholder:"http://localhost:9411"}),(0,t.jsx)(o.Divider,{spacing:4}),(0,t.jsx)(et,mr({},pt({config:e,onChange:r}))),(0,t.jsx)(o.Divider,{spacing:4}),(0,t.jsx)(Ht,{options:e,onOptionsChange:r}),(0,t.jsx)(o.Divider,{spacing:4}),(0,t.jsx)(Xt,{options:e,onOptionsChange:r}),(0,t.jsx)(o.Divider,{spacing:4}),(0,t.jsx)(k,{title:"Additional settings",description:"Additional settings are optional settings that can be configured for more control over your data source.",isCollapsible:!0,isInitiallyOpen:!1,children:(0,t.jsxs)(o.Stack,{gap:5,direction:"column",children:[(0,t.jsx)(Pt,{config:e,onChange:r}),Et.config.secureSocksDSProxyEnabled&&(0,t.jsx)(o.SecureSocksProxySettings,{options:e,onOptionsChange:r}),(0,t.jsx)(nr,{options:e,onOptionsChange:r}),(0,t.jsx)(pr,{options:e,onOptionsChange:r})]})})]})}))})(),u})()));
//# sourceMappingURL=module.js.map